# %% Imports
import pandas as pd
import geopandas as gpd
import rasterstats
import rioxarray
import rasterio as rio

# %%
START_YEAR = 2000
END_YEAR = 2015
VULNERABILITY_PATH = "C:/Users/wja209/DATA/RAW/doi_10.5061_dryad.dk1j0__v2/GDP_per_capita_PPP_1990_2015_v2.nc"
EXPOSURE_PATH = "C:/Users/wja209/DATA/RAW/gpw-v4-population-count-rev11_totpop_2pt5_min_nc/gpw_v4_population_count_rev11_2pt5_min.nc"
PROCESSED_IMPACT_PATH = "C:/Users/wja209/DATA/PROCESSED/impact_1990_2015.gpkg"
PROCESSED_IMPACT_AND_VUL_PATH = (
    "C:/Users/wja209/DATA/PROCESSED/impact_vulnerability_1990_2015.gpkg"
)
# %%
ds_vul = rioxarray.open_rasterio(VULNERABILITY_PATH)

# %%
df_impact = gpd.read_file(PROCESSED_IMPACT_PATH)

# %%
impact_years = df_impact["Start Date"].dt.year.dropna().unique()

# %%
for year in impact_years:
    print(year)
    year_filter = df_impact["Start Date"].dt.year == year
    ds_vul_year = ds_vul.sel(time=str(year))
    affine = rio.open(VULNERABILITY_PATH).transform
    df_impact.loc[year_filter, "GDP per Capita PPP"] = [
        x["mean"]
        for x in rasterstats.zonal_stats(
            df_impact.loc[year_filter, "geometry"],
            ds_vul_year.values,
            affine=affine,
            stats="mean",
        )
    ]

# %% Save merged file
df_impact.to_file(PROCESSED_IMPACT_AND_VUL_PATH)
