# %% Imports
import geopandas as gpd
import rasterstats
import rioxarray
import rasterio as rio

# %%
START_YEAR = 2000
END_YEAR = 2015
VULNERABILITY_PATH = "C:/Users/wja209/DATA/RAW/doi_10.5061_dryad.dk1j0__v2/GDP_per_capita_PPP_2000_2015_v2.nc"
PROCESSED_IMPACT_PATH = "C:/Users/wja209/DATA/PROCESSED/impact_2000_2015.gpkg"
PROCESSED_IMPACT_AND_VUL_PATH = (
    "C:/Users/wja209/DATA/PROCESSED/impact_vulnerability_2000_2015.gpkg"
)
# %%
vul = rio.open(VULNERABILITY_PATH)
affine = vul.transform
nodata = vul.nodata
ds_vul = rioxarray.open_rasterio(VULNERABILITY_PATH)

# %%
gdf_impact = gpd.read_file(PROCESSED_IMPACT_PATH)

# %%
impact_years = gdf_impact["Start Date"].dt.year.dropna().unique()

# %%
for year in impact_years:
    print(year)
    year_filter = gdf_impact["Start Date"].dt.year == year
    ds_vul_year = ds_vul.sel(time=str(year))
    gdf_impact.loc[year_filter, "GDP per Capita PPP"] = [
        x["mean"]
        for x in rasterstats.zonal_stats(
            gdf_impact.loc[year_filter, "geometry"],
            ds_vul_year.values,
            nodata=nodata,
            affine=affine,
            stats="mean",
        )
    ]

# %% Save merged file
gdf_impact.to_file(PROCESSED_IMPACT_AND_VUL_PATH)
