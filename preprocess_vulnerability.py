# %% Imports
import pandas as pd
import geopandas as gpd
import rasterstats
import rioxarray
import rasterio as rio

# %%
START_YEAR = 2000
END_YEAR = 2015
VULNERABILITY_PATH = "C:/Users/wja209/DATA/RAW/doi_10.5061_dryad.dk1j0__v2/GDP_per_capita_PPP_1990_2015_v2.nc"
PROCESSED_IMPACT_PATH = "C:/Users/wja209/DATA/PROCESSED/impact_1990_2015.gpkg"

# %%
ds_vul = rioxarray.open_rasterio(VULNERABILITY_PATH)

# %%
years = [str(x) for x in range(START_YEAR, END_YEAR + 1)]
ds_vul_2000_2015 = ds_vul.sel(time=years)
del ds_vul


# %%
df_impact = gpd.read_file(PROCESSED_IMPACT_PATH)

# %%
for year in years:
    year_filter = df_impact["Start Date"].dt.year == int(year)
    ds_vul_year = ds_vul_2000_2015.sel(time=year)
    affine = rio.open(VULNERABILITY_PATH).transform
    df_impact.loc[year_filter, "GDP per Capita PPP"] = [
        x["mean"]
        for x in rasterstats.zonal_stats(
            df_impact.loc[year_filter, "geometry"],
            ds_vul_year.values,
            affine=affine,
            stats="mean",
        )
    ]
