# %%
import seaborn as sns
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import scipy.stats
import statsmodels.api as sm
import geopandas as gpd

# %% Constants
PROCESSED_IMPACT_EXP_AND_VUL_PATH = (
    "C:/Users/wja209/DATA/PROCESSED/impact_exposure_vulnerability_2000_2015.gpkg"
)
EMDAT_PATH = "C:/Users/wja209/DATA/RAW/EM-DAT/emdat_public_2023_03_31_query_uid-n7b9hv-natural-sisasters.csv"


# %% Read data set
gdf_impact = gpd.read_file(PROCESSED_IMPACT_EXP_AND_VUL_PATH).set_index("Dis No")
df_emdat = pd.read_csv(EMDAT_PATH, delimiter=";").set_index("Dis No")

# %% Temporary fix:
gdf_impact.loc[:, "Total Deaths"] = df_emdat.loc[:, "Total Deaths"]
gdf_impact.loc[:, "Dis Mag Value"] = df_emdat.loc[:, "Dis Mag Value"]
gdf_impact.loc[:, "Dis Mag Scale"] = df_emdat.loc[:, "Dis Mag Scale"]

# %%
gdf_impact = gdf_impact.dropna(
    subset=[
        "Total Deaths",
        "Population Count",
        "GDP per Capita PPP",
        "Dis Mag Value",
        "Dis Mag Scale",
    ]
)

# %%
df_cross = gdf_impact.reset_index().merge(
    gdf_impact.reset_index(), how="cross", suffixes=["_1", "_2"]
)

# %% Remove combinations of same event
filter = df_cross["Dis No_1"] == df_cross["Dis No_2"]
df_cross = df_cross[~filter]

# %%   Filter hazards with spatial overlap
spatial_filter = gpd.GeoSeries(df_cross["geometry_1"]).intersects(
    gpd.GeoSeries(df_cross["geometry_2"])
)
df_cross = df_cross[spatial_filter]

# %%
